services:
  google_agents_mariadb:
    image: mariadb:11.4
    container_name: agent_mariadb
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: agent_db
      MYSQL_USER: agent_user
      MYSQL_PASSWORD: agent_password
    ports:
      - "3307:3306" # Avoid conflict with local MariaDB if running
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - agent_network

  google_agents_frontend:
    build:
      context: ./docker/frontend
      dockerfile: Dockerfile
    container_name: agent_frontend
    env_file:
      - ./docker/frontend/frontend.env
    volumes:
      - ./src:/app/src
    depends_on:
      - google_agents_mariadb
      - google_agents_db_setup
    ports:
      - "8000:8000"
    networks:
      - agent_network

  google_agents_db_setup:
    image: mariadb:11.4
    container_name: agent_db_setup
    volumes:
      - ./src/schema.sql:/schema.sql
    depends_on:
      - google_agents_mariadb
    networks:
      - agent_network
    command: >
      /bin/sh -c "
      echo 'Waiting for MariaDB to be ready...';
      while ! mariadb-admin ping -h google_agents_mariadb -uagent_user -pagent_password --silent; do
        sleep 1;
      done;
      echo 'Importing schema...';
      mariadb -h google_agents_mariadb -uagent_user -pagent_password agent_db < /schema.sql;
      echo 'Schema imported successfully.';
      "

networks:
  agent_network:
    driver: bridge

volumes:
  mariadb_data:
